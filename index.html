<!DOCTYPE html>
<html>
<head>
  <title>USGS Flow and AF Inflow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 0 10px;
    }
    #flows {
      list-style: none;
      padding: 0;
      margin-bottom: 0.2em;
      font-size: 1.1em;
    }
    #flows li {
      margin: 0.2em 0;
    }
    hr {
      border: none;
      border-top: 1px solid #333;
      margin: 0.4em 0;
    }
    h2 {
      font-weight: bold;
      font-size: 1.3em;
    }
    canvas {
      width: 100% !important;
      height: 250px !important;
    }
  </style>
</head>
<body>
  <h1>USGS Flow Data</h1>
  <ul id="flows"></ul>
  <hr>
  <h2>AF Inflow: <span id="total">0</span> cfs</h2>

  <canvas id="flowChart"></canvas>

  <script>
    const siteIDs = [
      '12389000', // Clark Fork near Plains, MT
      '12389500', // Thompson River near Thompson Falls, MT
      '12390700', // Prospect Creek at Thompson Falls, MT
      '12392155', // Lightning Creek at Clark Fork, ID
      '12395000'  // Priest River near Priest River, ID
    ];

    const flowsEl = document.getElementById('flows');
    const totalEl = document.getElementById('total');
    const ctx = document.getElementById('flowChart').getContext('2d');

    function formatFlow(value) {
      return Math.round(value).toLocaleString();
    }

    const now = new Date();
    const endDT = now.toISOString();
    const startDT = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();

    Promise.all(siteIDs.map(id =>
      fetch(`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=${id}&parameterCd=00060&startDT=${startDT}&endDT=${endDT}`)
        .then(res => res.json())
        .then(data => {
          try {
            const ts = data.value.timeSeries;
            if (!ts || ts.length === 0) return null;
            const siteName = ts[0].sourceInfo.siteName;
            const values = ts[0].values[0].value;
            if (!values || values.length === 0) return null;

            let latestFlow = null;
            for (let i = values.length - 1; i >= 0; i--) {
              if (values[i].value !== null && values[i].value !== undefined && values[i].value !== '') {
                latestFlow = parseFloat(values[i].value);
                break;
              }
            }
            if (latestFlow === null) return null;

            const times = values.map(v => new Date(v.dateTime));
            const flows = values.map(v => {
              let val = parseFloat(v.value);
              return isNaN(val) ? 0 : val;
            });

            return { siteName, latestFlow, times, flows };
          } catch (e) {
            console.warn('Error parsing data for site:', id, e);
            return null;
          }
        })
        .catch(err => {
          console.warn('Fetch error for site:', id, err);
          return null;
        })
    )).then(sitesDataRaw => {
      const sitesData = sitesDataRaw.filter(d => d !== null);
      if (sitesData.length === 0) {
        flowsEl.innerHTML = '<li>No valid data available.</li>';
        totalEl.textContent = '0';
        return;
      }

      flowsEl.innerHTML = '';
      let totalLatest = 0;
      sitesData.forEach(site => {
        flowsEl.innerHTML += `<li>${site.siteName}: ${formatFlow(site.latestFlow)} cfs</li>`;
