<!DOCTYPE html>
<html>
<head>
  <title>USGS Flow and AF Inflow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 0 10px;
    }
    #flows {
      list-style: none;
      padding: 0;
      margin-bottom: 0.2em;
      font-size: 1.1em;
    }
    #flows li {
      margin: 0.2em 0;
    }
    hr {
      border: none;
      border-top: 1px solid #333;
      margin: 0.4em 0;
    }
    h2 {
      font-weight: bold;
      font-size: 1.3em;
    }
    canvas {
      width: 100% !important;
      height: 250px !important;
    }
  </style>
</head>
<body>
  <h1>USGS Flow Data</h1>
  <ul id="flows"></ul>
  <hr>
  <h2>AF Inflow: <span id="total">0</span> cfs</h2>

  <canvas id="flowChart"></canvas>

  <script>
    const siteIDs = [
      '12389000', // Clark Fork near Plains, MT
      '12389500', // Thompson River near Thompson Falls, MT
      '12390700', // Prospect Creek at Thompson Falls, MT
      '12392155', // Lightning Creek at Clark Fork, ID
      '12395000'  // Priest River near Priest River, ID
    ];

    const flowsEl = document.getElementById('flows');
    const totalEl = document.getElementById('total');
    const ctx = document.getElementById('flowChart').getContext('2d');

    function formatFlow(value) {
      return Math.round(value).toLocaleString();
    }

    const now = new Date();
    const endDT = now.toISOString();
    const startDT = new Date(now.getTime() - 24*60*60*1000).toISOString();

    Promise.all(siteIDs.map(id =>
      fetch(`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=${id}&parameterCd=00060&startDT=${startDT}&endDT=${endDT}`)
        .then(res => res.json())
        .then(data => {
          const siteName = data.value.timeSeries[0].sourceInfo.siteName;
          const values = data.value.timeSeries[0].values[0].value;
          const latestFlow = parseFloat(values[values.length - 1].value);
          const times = values.map(v => new Date(v.dateTime));
          const flows = values.map(v => parseFloat(v.value));
          return { siteName, latestFlow, times, flows };
        })
    )).then(sitesData => {
      flowsEl.innerHTML = '';
      let totalLatest = 0;
      sitesData.forEach(site => {
        flowsEl.innerHTML += `<li>${site.siteName}: ${formatFlow(site.latestFlow)} cfs</li>`;
        totalLatest += site.latestFlow;
      });

      const hr = document.createElement('hr');
      flowsEl.parentNode.insertBefore(hr, totalEl.parentNode);
      totalEl.textContent = formatFlow(totalLatest);

      const labels = sitesData[0].times.map(t => t.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
      const totalFlows = [];
      for (let i = 0; i < labels.length; i++) {
        let sum = 0;
        sitesData.forEach(site => {
          sum += site.flows[i] || 0;
        });
        totalFlows.push(Math.round(sum));
      }

      const minFlow = Math.min(...totalFlows);
      const maxFlow = Math.max(...totalFlows);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'AF Inflow (cfs)',
            data: totalFlows,
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'transpar
